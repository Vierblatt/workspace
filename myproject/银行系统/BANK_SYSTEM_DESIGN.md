# 银行业务模拟系统设计文档

## 1. 问题描述

根据《数据结构实验指导书》题目4的要求，本系统需要实现一个银行业务的事件驱动模拟系统，通过模拟方法求出客户在银行内逗留的平均时间。

### 业务规则
1. 客户业务分为两种：
   - 第一种：申请从银行得到一笔资金（取款或借款）
   - 第二种：向银行投入一笔资金（存款或还款）

2. 银行有两个服务窗口，相应地有两个队列：
   - 客户到达银行后先排第一个队
   - 处理每个客户业务时，如果属于第一种业务且申请额超出银行现存资金总额而得不到满足，则立刻排入第二个队等候，直至满足时才离开银行；否则业务处理完后立刻离开银行

3. 每接待完一个第二种业务的客户，则顺序检查和处理第二个队列中的客户，对能满足的申请者予以满足，不能满足者重新排到第二个队列的队尾

4. 营业时间结束时所有客户立即离开银行

## 2. 系统设计

### 2.1 数据结构设计

#### 2.1.1 客户结构体 (Customer)
```c
typedef struct Customer {
    int arrive_time;        // 到达时间
    int duration;           // 服务时间
    int amount;             // 交易金额（正数表示存款，负数表示取款）
    struct Customer* next;
} Customer;
```

#### 2.1.2 事件结构体 (Event)
```c
typedef struct Event {
    int occur_time;         // 事件发生时间
    int event_type;         // 事件类型（0表示到达事件，1表示离开事件）
    struct Customer* customer; // 相关客户
    struct Event* next;
} Event;
```

#### 2.1.3 队列结构体 (Queue)
```c
typedef struct Queue {
    Customer* front;
    Customer* rear;
} Queue;
```

#### 2.1.4 银行系统结构体 (BankSystem)
```c
typedef struct BankSystem {
    int total_money;        // 银行总资金
    int current_time;       // 当前时间
    int close_time;         // 关门时间
    Queue queue1;           // 第一个队列（正在等待服务的客户）
    Queue queue2;           // 第二个队列（因资金不足而等待的客户）
    Event* event_list;      // 事件列表
    int total_customers;    // 总客户数
    int total_wait_time;    // 总等待时间
} BankSystem;
```

### 2.2 核心算法

#### 2.2.1 事件驱动模拟
系统采用事件驱动的方式进行模拟，主要处理两类事件：
1. 客户到达事件
2. 客户离开事件

事件按照发生时间顺序存储在事件列表中，每次取出最早发生的事件进行处理。

#### 2.2.2 客户服务流程
1. 客户到达时，加入第一个队列
2. 队列首客户接受服务，创建离开事件
3. 根据业务类型和银行资金情况决定客户去向：
   - 存款业务：直接完成，更新银行资金
   - 取款业务：资金充足则完成，资金不足则加入等待队列
4. 存款业务完成后，检查并处理等待队列中的客户

#### 2.2.3 等待队列处理
每当有存款业务完成时，系统会检查等待队列中的客户：
- 按顺序检查每个客户是否可以获得服务
- 能满足的客户完成交易
- 不能满足的客户重新排队
- 当银行资金不再增加或处理一定数量客户后停止检查

### 2.3 系统流程

```
开始
  ↓
初始化银行系统
  ↓
创建第一个客户到达事件
  ↓
循环处理事件直到营业时间结束
  ↓
处理剩余客户
  ↓
输出统计信息
  ↓
结束
```

## 3. 功能实现

### 3.1 主要功能模块

#### 3.1.1 队列操作
- `init_queue`: 初始化队列
- `is_queue_empty`: 检查队列是否为空
- `enqueue`: 入队操作
- `dequeue`: 出队操作
- `queue_front`: 获取队首元素

#### 3.1.2 事件管理
- `init_event_list`: 初始化事件列表
- `insert_event`: 插入事件（按时间顺序）
- `get_next_event`: 获取下一个事件

#### 3.1.3 客户管理
- `create_customer`: 创建随机客户
- `handle_arrive_event`: 处理客户到达事件
- `handle_leave_event`: 处理客户离开事件
- `process_queue2`: 处理等待队列

#### 3.1.4 系统控制
- `run_simulation`: 运行模拟
- `print_statistics`: 打印统计信息

### 3.2 关键处理逻辑

#### 3.2.1 客户到达处理
1. 创建客户对象，随机生成服务时间和交易金额
2. 将客户加入第一个队列
3. 生成下一个客户到达事件

#### 3.2.2 客户离开处理
1. 计算客户逗留时间并累加
2. 根据业务类型处理：
   - 存款：增加银行资金，处理等待队列
   - 取款：检查资金是否充足，充足则完成，不足则加入等待队列

#### 3.2.3 等待队列处理
1. 按顺序检查等待队列中的客户
2. 资金充足的客户完成交易
3. 资金仍不足的客户重新排队
4. 适当条件下停止处理以避免无限循环

## 4. 测试方案

### 4.1 测试数据设置
- 初始资金：10000元
- 营业时间：600分钟
- 客户到达间隔：1-10分钟随机
- 服务时间：1-20分钟随机
- 交易金额：-5000到5000元随机

### 4.2 极端情况测试
1. 客户到达间隔短，服务时间长
2. 客户到达间隔长，服务时间短

### 4.3 预期结果
- 系统能够正确处理所有客户事件
- 正确计算客户平均逗留时间
- 合理处理资金不足情况
- 营业时间结束时正确清理系统

## 5. 编译与运行

### 5.1 编译方法
```bash
# 使用GCC直接编译
gcc -o bank_simulation BankSimulation.c main_bank.c

# 或使用Makefile
make
```

### 5.2 运行方法
```bash
# 直接运行
./bank_simulation

# 或使用Makefile
make run
```

### 5.3 清理
```bash
# 清理编译生成的文件
make clean
```

## 6. 系统特点

### 6.1 优点
1. **事件驱动**：采用事件驱动模拟，时间效率高
2. **动态内存管理**：使用动态内存分配，内存使用灵活
3. **模块化设计**：功能模块划分清晰，便于维护和扩展
4. **完整统计**：提供详细的统计信息，便于分析

### 6.2 可能的改进
1. **图形界面**：可以添加图形界面以更直观地显示模拟过程
2. **参数配置文件**：可以通过配置文件设置模拟参数
3. **日志记录**：添加详细的日志记录功能
4. **多窗口支持**：实现真正的多窗口服务

## 7. 总结

本银行模拟系统完整实现了《数据结构实验指导书》中题目4的要求，通过事件驱动的方式模拟银行营业过程，能够准确计算客户在银行内的平均逗留时间。系统设计合理，代码结构清晰，具有良好的可扩展性和可维护性。